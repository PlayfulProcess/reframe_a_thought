<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Inner Freedom Journey - Jongu</title>
  <meta name="description" content="AI-guided exploration through CBT, NVC, and Byron Katie's The Work to transform limiting thoughts into freedom.">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-green: #1DB954;
      --primary-blue: #4A90E2;
      --warm-yellow: #FFD600;
      --soft-red: #E74C3C;
      --background: #F0F4F8;
      --card-bg: #fff;
      --text-dark: #222;
      --text-medium: #333;
      --border-light: #eee;
      --shadow: 0 4px 16px rgba(0,0,0,0.08);
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--background);
      color: var(--text-medium);
      margin: 0;
      padding: 0;
      line-height: 1.6;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 1rem;
    }

    .header {
      text-align: center;
      margin-bottom: 2rem;
      background: linear-gradient(135deg, var(--primary-green), var(--primary-blue));
      border-radius: 20px;
      padding: 2rem;
      color: white;
      box-shadow: var(--shadow);
    }

    .header h1 {
      margin: 0 0 0.5rem 0;
      font-size: 2.5rem;
      font-weight: 700;
    }

    .header p {
      margin: 0;
      font-size: 1.1rem;
      opacity: 0.9;
    }

    .main-layout {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 2rem;
      align-items: start;
    }

    .chat-section {
      background: var(--card-bg);
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 2rem;
      min-height: 600px;
      display: flex;
      flex-direction: column;
    }

    .methodology-tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }

    .tab-btn {
      padding: 0.7rem 1.2rem;
      border: 2px solid var(--border-light);
      background: white;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      flex: 1;
      min-width: 120px;
    }

    .tab-btn.active {
      background: var(--primary-green);
      color: white;
      border-color: var(--primary-green);
    }

    .tab-btn:hover:not(.active) {
      border-color: var(--primary-green);
      background: #f8fff8;
    }

    .chat-box {
      flex: 1;
      border: 1px solid var(--border-light);
      border-radius: 12px;
      padding: 1.5rem;
      background: #F8FBFF;
      min-height: 400px;
      max-height: 500px;
      overflow-y: auto;
      margin-bottom: 1rem;
      font-size: 1.05em;
    }

    .message {
      margin-bottom: 1.5rem;
      display: flex;
      align-items: flex-start;
      animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message.ai .bubble {
      background: linear-gradient(135deg, #e6f7ec, #f0fff4);
      color: var(--text-dark);
      margin-right: auto;
      border: 1px solid var(--primary-green);
    }

    .message.user .bubble {
      background: linear-gradient(135deg, #f0f8ff, #e6f3ff);
      color: var(--text-medium);
      margin-left: auto;
      border: 1px solid var(--primary-blue);
    }

    .bubble {
      padding: 1rem 1.3rem;
      border-radius: 20px;
      max-width: 85%;
      box-shadow: 0 2px 12px rgba(0,0,0,0.05);
      word-break: break-word;
      line-height: 1.5;
    }

    .input-area {
      display: flex;
      gap: 12px;
      align-items: flex-end;
    }

    .input-area textarea {
      flex: 1;
      padding: 1rem;
      border-radius: 12px;
      border: 2px solid var(--border-light);
      font-size: 1rem;
      resize: none;
      font-family: inherit;
      transition: border-color 0.3s ease;
      min-height: 60px;
    }

    .input-area textarea:focus {
      outline: none;
      border-color: var(--primary-green);
    }

    .send-btn {
      background: linear-gradient(135deg, var(--warm-yellow), #ffed4e);
      color: var(--text-dark);
      border: none;
      border-radius: 12px;
      padding: 1rem 1.5rem;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(255, 214, 0, 0.3);
      min-height: 60px;
    }

    .send-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(255, 214, 0, 0.4);
    }

    .send-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .insights-panel {
      background: var(--card-bg);
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 1.5rem;
    }

    .insights-panel h3 {
      margin: 0 0 1rem 0;
      color: var(--text-dark);
      font-weight: 700;
    }

    .insight-item {
      background: linear-gradient(135deg, #f8f9ff, #fff);
      border: 2px solid var(--border-light);
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 1rem;
      transition: all 0.3s ease;
    }

    .insight-item:hover {
      border-color: var(--primary-blue);
      transform: translateY(-1px);
    }

    .insight-label {
      font-weight: 600;
      color: var(--primary-blue);
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .insight-content {
      margin-top: 0.5rem;
      color: var(--text-medium);
    }

    .tools-panel {
      background: var(--card-bg);
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 1.5rem;
    }

    .tool-btn {
      width: 100%;
      padding: 1rem;
      margin-bottom: 0.8rem;
      background: linear-gradient(135deg, #fff, #f8f9fa);
      border: 2px solid var(--border-light);
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: left;
    }

    .tool-btn:hover {
      border-color: var(--primary-green);
      background: linear-gradient(135deg, #f8fff8, #fff);
      transform: translateY(-1px);
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.3);
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
    }

    .modal-content {
      background: var(--card-bg);
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.2);
      padding: 2rem;
      max-width: 90vw;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
      min-width: 320px;
    }

    .modal-close {
      position: absolute;
      top: 1rem;
      right: 1.5rem;
      font-size: 1.8rem;
      color: #aaa;
      background: none;
      border: none;
      cursor: pointer;
      font-weight: bold;
      transition: color 0.3s;
    }

    .modal-close:hover {
      color: var(--soft-red);
    }

    .feelings-grid, .needs-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 0.8rem;
      margin-top: 1rem;
    }

    .feeling-tag, .need-tag {
      padding: 0.8rem 1rem;
      border: 2px solid var(--primary-green);
      border-radius: 12px;
      background: #f8fff8;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
      font-weight: 600;
      color: var(--primary-green);
    }

    .feeling-tag.unmet {
      border-color: var(--soft-red);
      background: #fff8f8;
      color: var(--soft-red);
    }

    .need-tag {
      border-color: var(--primary-blue);
      background: #f8fbff;
      color: var(--primary-blue);
    }

    .feeling-tag:hover, .need-tag:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: var(--border-light);
      border-radius: 4px;
      margin: 1rem 0;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary-green), var(--primary-blue));
      width: 0%;
      transition: width 0.5s ease;
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid var(--border-light);
      border-radius: 50%;
      border-top-color: var(--primary-green);
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .jongu-footer {
      text-align: center;
      padding: 2rem 1rem;
      background: linear-gradient(135deg, var(--primary-green), var(--primary-blue));
      color: white;
      border-radius: 20px;
      margin-top: 2rem;
    }

    .jongu-footer a {
      color: white;
      text-decoration: none;
      font-weight: 600;
    }

    .jongu-footer a:hover {
      text-decoration: underline;
    }

    @media (max-width: 1024px) {
      .main-layout {
        grid-template-columns: 1fr;
        gap: 1.5rem;
      }
      
      .header h1 {
        font-size: 2rem;
      }
      
      .container {
        padding: 0.5rem;
      }
    }

    @media (max-width: 768px) {
      .methodology-tabs {
        flex-direction: column;
      }
      
      .tab-btn {
        min-width: unset;
      }
      
      .main-layout {
        gap: 1rem;
      }
      
      .chat-section {
        padding: 1rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Inner Freedom Journey</h1>
      <p>AI-guided exploration through CBT, NVC, and The Work to transform limiting thoughts</p>
    </div>

    <div class="main-layout">
      <div class="chat-section">
        <div class="methodology-tabs">
          <button class="tab-btn active" data-method="integrated">Integrated Approach</button>
          <button class="tab-btn" data-method="cbt">CBT Focus</button>
          <button class="tab-btn" data-method="nvc">NVC Focus</button>
          <button class="tab-btn" data-method="byron">The Work</button>
        </div>

        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
        </div>

        <div class="chat-box" id="chatBox">
          <div class="message ai">
            <div class="bubble">
              Welcome to your Inner Freedom Journey. I'm here to guide you through a transformative exploration using proven methodologies for emotional freedom and mental clarity.
              <br><br>
              <strong>Let's begin:</strong> What thought, belief, or situation is causing you stress or limiting your sense of freedom right now?
            </div>
          </div>
        </div>

        <div class="input-area">
          <textarea 
            id="userInput" 
            placeholder="Share what's on your mind..."
            rows="3"
          ></textarea>
          <button id="sendBtn" class="send-btn">
            <span id="sendText">Send</span>
            <span id="loadingSpinner" class="loading" style="display: none;"></span>
          </button>
        </div>
      </div>

      <div class="sidebar">
        <div class="insights-panel">
          <h3>Your Journey Insights</h3>
          <div id="insightsContainer">
            <div class="insight-item">
              <div class="insight-label">Getting Started</div>
              <div class="insight-content">Your responses will be analyzed to identify patterns and provide personalized guidance.</div>
            </div>
          </div>
        </div>

        <div class="tools-panel">
          <h3>Exploration Tools</h3>
          <button class="tool-btn" id="feelingsBtn">Feelings Explorer</button>
          <button class="tool-btn" id="needsBtn">Needs Identifier</button>
          <button class="tool-btn" id="byronBtn">The Four Questions</button>
          <button class="tool-btn" id="cbtBtn">Thought Patterns</button>
          <button class="tool-btn" id="exportBtn">Export Journey</button>
        </div>
      </div>
    </div>

    <div class="jongu-footer">
      <p>Part of the <a href="https://jongu.org" target="_blank">Jongu</a> ecosystem - Building bridges between worlds through technology and wisdom</p>
    </div>
  </div>

  <!-- Feelings Modal -->
  <div class="modal" id="feelingsModal">
    <div class="modal-content">
      <button class="modal-close">&times;</button>
      <h2>Feelings Explorer</h2>
      <p>Tap any feeling that resonates with your current experience:</p>
      
      <h3 style="color: var(--primary-green);">When Needs Are Met</h3>
      <div class="feelings-grid" id="feelingsMet"></div>
      
      <h3 style="color: var(--soft-red);">When Needs Are Unmet</h3>
      <div class="feelings-grid" id="feelingsUnmet"></div>
    </div>
  </div>

  <!-- Needs Modal -->
  <div class="modal" id="needsModal">
    <div class="modal-content">
      <button class="modal-close">&times;</button>
      <h2>Universal Human Needs</h2>
      <p>Which needs are calling for attention in your life?</p>
      <div class="needs-grid" id="needsGrid"></div>
    </div>
  </div>

  <!-- Byron Katie Modal -->
  <div class="modal" id="byronModal">
    <div class="modal-content">
      <button class="modal-close">&times;</button>
      <h2>The Four Questions (Byron Katie)</h2>
      <div style="padding: 1rem; background: #f8f9fa; border-radius: 12px; margin: 1rem 0;">
        <h3>About your stressful thought:</h3>
        <ol style="line-height: 2;">
          <li><strong>Is it true?</strong></li>
          <li><strong>Can you absolutely know that it's true?</strong></li>
          <li><strong>How do you react when you believe that thought?</strong></li>
          <li><strong>Who would you be without that thought?</strong></li>
        </ol>
        <p><strong>Turn it around:</strong> Find three genuine ways to turn the thought around and find evidence for each turnaround.</p>
      </div>
    </div>
  </div>

  <!-- CBT Modal -->
  <div class="modal" id="cbtModal">
    <div class="modal-content">
      <button class="modal-close">&times;</button>
      <h2>Common Thought Patterns</h2>
      <div style="display: grid; gap: 1rem; margin-top: 1rem;">
        <div class="insight-item">
          <div class="insight-label">All-or-Nothing Thinking</div>
          <div class="insight-content">Seeing things in black and white categories</div>
        </div>
        <div class="insight-item">
          <div class="insight-label">Catastrophizing</div>
          <div class="insight-content">Expecting the worst possible outcome</div>
        </div>
        <div class="insight-item">
          <div class="insight-label">Mind Reading</div>
          <div class="insight-content">Assuming you know what others think</div>
        </div>
        <div class="insight-item">
          <div class="insight-label">Should Statements</div>
          <div class="insight-content">Rigid expectations about how things "should" be</div>
        </div>
        <div class="insight-item">
          <div class="insight-label">Emotional Reasoning</div>
          <div class="insight-content">Believing feelings represent facts</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Data structures
    const feelingsMet = [
      'Peaceful', 'Joyful', 'Grateful', 'Content', 'Energetic', 'Confident',
      'Loving', 'Hopeful', 'Excited', 'Calm', 'Fulfilled', 'Inspired',
      'Connected', 'Secure', 'Enthusiastic', 'Delighted', 'Serene', 'Blissful'
    ];

    const feelingsUnmet = [
      'Anxious', 'Frustrated', 'Sad', 'Angry', 'Overwhelmed', 'Lonely',
      'Confused', 'Worried', 'Disappointed', 'Stressed', 'Fearful', 'Hurt',
      'Disconnected', 'Restless', 'Irritated', 'Discouraged', 'Tense', 'Empty'
    ];

    const needs = [
      'Connection', 'Understanding', 'Love', 'Acceptance', 'Safety', 'Freedom',
      'Autonomy', 'Respect', 'Honesty', 'Trust', 'Support', 'Recognition',
      'Purpose', 'Growth', 'Creativity', 'Peace', 'Joy', 'Adventure',
      'Rest', 'Beauty', 'Order', 'Meaning', 'Contribution', 'Community'
    ];

    // Application state
    let currentMethod = 'integrated';
    let conversationHistory = [];
    let userInsights = {
      thoughts: [],
      feelings: [],
      needs: [],
      patterns: []
    };
    let currentStep = 0;
    const totalSteps = 8;

    // DOM elements
    const chatBox = document.getElementById('chatBox');
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');
    const sendText = document.getElementById('sendText');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const progressFill = document.getElementById('progressFill');
    const insightsContainer = document.getElementById('insightsContainer');

    // Initialize the application
    function init() {
      setupEventListeners();
      populateModals();
      updateProgress();
    }

    function setupEventListeners() {
      // Send button and enter key
      sendBtn.addEventListener('click', handleSendMessage);
      userInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          handleSendMessage();
        }
      });

      // Methodology tabs
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          e.target.classList.add('active');
          currentMethod = e.target.dataset.method;
        });
      });

      // Tool buttons
      document.getElementById('feelingsBtn').addEventListener('click', () => openModal('feelingsModal'));
      document.getElementById('needsBtn').addEventListener('click', () => openModal('needsModal'));
      document.getElementById('byronBtn').addEventListener('click', () => openModal('byronModal'));
      document.getElementById('cbtBtn').addEventListener('click', () => openModal('cbtModal'));
      document.getElementById('exportBtn').addEventListener('click', exportJourney);

      // Modal close buttons
      document.querySelectorAll('.modal-close').forEach(btn => {
        btn.addEventListener('click', (e) => {
          closeModal(e.target.closest('.modal').id);
        });
      });

      // Close modals on backdrop click
      document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            closeModal(modal.id);
          }
        });
      });
    }

    function populateModals() {
      // Feelings
      const feelingsMetEl = document.getElementById('feelingsMet');
      const feelingsUnmetEl = document.getElementById('feelingsUnmet');
      
      feelingsMet.forEach(feeling => {
        const tag = document.createElement('div');
        tag.className = 'feeling-tag';
        tag.textContent = feeling;
        tag.addEventListener('click', () => selectFeeling(feeling, true));
        feelingsMetEl.appendChild(tag);
      });

      feelingsUnmet.forEach(feeling => {
        const tag = document.createElement('div');
        tag.className = 'feeling-tag unmet';
        tag.textContent = feeling;
        tag.addEventListener('click', () => selectFeeling(feeling, false));
        feelingsUnmetEl.appendChild(tag);
      });

      // Needs
      const needsGridEl = document.getElementById('needsGrid');
      needs.forEach(need => {
        const tag = document.createElement('div');
        tag.className = 'need-tag';
        tag.textContent = need;
        tag.addEventListener('click', () => selectNeed(need));
        needsGridEl.appendChild(tag);
      });
    }

    async function handleSendMessage() {
      const message = userInput.value.trim();
      if (!message || sendBtn.disabled) return;

      // Add user message
      addMessage('user', message);
      userInput.value = '';
      
      // Update conversation history
      conversationHistory.push({ role: 'user', content: message });

      // Show loading state
      setLoadingState(true);

      try {
        // Get AI response
        const aiResponse = await getAIResponse(message, currentMethod);
        addMessage('ai', aiResponse);
        
        // Update insights
        updateInsights(message, aiResponse);
        
        // Progress tracking
        currentStep = Math.min(currentStep + 1, totalSteps);
        updateProgress();

      } catch (error) {
        console.error('Error getting AI response:', error);
        addMessage('ai', "I'm having trouble processing that right now. Could you try rephrasing your thought or feeling?");
      } finally {
        setLoadingState(false);
      }
    }

    async function getAIResponse(userMessage, method) {
      // Check if Claude API is available
      if (typeof window.claude === 'undefined' || typeof window.claude.complete !== 'function') {
        // Fallback responses when Claude API is not available
        return getFallbackResponse(userMessage, method);
      }

      // Build context based on methodology and conversation history
      const systemPrompt = buildSystemPrompt(method);
      const conversationContext = buildConversationContext();
      
      const prompt = `${systemPrompt}

CONVERSATION HISTORY:
${JSON.stringify(conversationContext)}

CURRENT USER MESSAGE: "${userMessage}"

METHODOLOGY FOCUS: ${method}

Please respond as a compassionate AI guide. Provide insights, gentle questioning, or next steps based on the chosen methodology. Keep responses conversational, supportive, and practical. If appropriate, suggest specific tools or techniques the user can try.

Respond with a JSON object in this exact format:
{
  "response": "Your supportive response to the user",
  "insights": {
    "thoughtPattern": "brief description of any thought pattern identified",
    "emotionalState": "brief description of emotional state",
    "suggestedAction": "specific suggestion for next step"
  }
}

Your entire response MUST be valid JSON only. Do not include any text outside the JSON structure.`;

      try {
        const response = await window.claude.complete(prompt);
        const parsedResponse = JSON.parse(response);
        
        // Store insights
        if (parsedResponse.insights) {
          if (parsedResponse.insights.thoughtPattern) {
            userInsights.patterns.push(parsedResponse.insights.thoughtPattern);
          }
          if (parsedResponse.insights.emotionalState) {
            userInsights.feelings.push(parsedResponse.insights.emotionalState);
          }
        }
        
        return parsedResponse.response;
      } catch (error) {
        console.error('Failed to parse AI response:', error);
        return getFallbackResponse(userMessage, method);
      }
    }

    function getFallbackResponse(userMessage, method) {
      // Fallback responses when API is not available
      const responses = {
        integrated: [
          "Thank you for sharing that with me. I can sense there's something important here for you to explore. Let's look at this from a few different angles. First, how does this thought or situation make you feel in your body right now?",
          "I hear you. Sometimes when we're caught in difficult thoughts, it can be helpful to step back and examine them more closely. What would it feel like to question whether this thought is absolutely true?",
          "That sounds challenging. Let's explore what might be underneath this feeling. What need of yours might not be getting met in this situation?",
          "I appreciate your willingness to look at this. Sometimes our thoughts create suffering when we believe them without question. How might your experience change if you held this thought more lightly?"
        ],
        cbt: [
          "I notice some patterns in what you're sharing. Let's examine this thought more closely - what evidence do you have that supports this belief? And what evidence might contradict it?",
          "This sounds like it might be an example of all-or-nothing thinking. Can you find any middle ground or gray areas in this situation?",
          "What would you tell a good friend who came to you with this exact same thought or worry?",
          "Let's do a thought experiment - if this thought were only 50% true instead of 100% true, how would that change how you feel about the situation?"
        ],
        nvc: [
          "Thank you for trusting me with this. I'm curious - when you think about this situation, what feelings come up for you?",
          "It sounds like there are some important needs involved here. What do you think you're needing most in this situation?",
          "I hear the pain in what you're sharing. Let's explore - if you could wave a magic wand and have your needs fully met, what would that look like?",
          "Sometimes conflict happens when our strategies clash, but our needs rarely conflict. What might the other person be needing in this situation?"
        ],
        byron: [
          "Let's slow down and really examine this thought that's causing you stress. First question: Is this thought true?",
          "Now let's go deeper - can you absolutely know, beyond any doubt, that this thought is true?",
          "Notice how you feel and how you react when you believe this thought. What does it do to your body, your emotions, your actions?",
          "Now imagine for a moment - who would you be, how would you feel, if you couldn't think this thought? What would be possible then?"
        ]
      };

      const methodResponses = responses[method] || responses.integrated;
      const randomIndex = Math.floor(Math.random() * methodResponses.length);
      return methodResponses[randomIndex];
    }

    function buildSystemPrompt(method) {
      const baseTone = "You are a compassionate AI guide specializing in inner freedom and emotional wellbeing. You help people identify and transform limiting thoughts and beliefs using evidence-based approaches.";
      
      switch (method) {
        case 'cbt':
          return `${baseTone} Focus primarily on Cognitive Behavioral Therapy techniques: identifying thought patterns, cognitive distortions, and helping users develop more balanced, realistic thoughts.`;
        
        case 'nvc':
          return `${baseTone} Focus primarily on Nonviolent Communication: helping users identify feelings and underlying needs, fostering self-connection and empathy.`;
        
        case 'byron':
          return `${baseTone} Focus primarily on Byron Katie's "The Work": guide users through inquiry using the four questions and turnarounds to question stressful thoughts.`;
        
        default:
          return `${baseTone} Integrate techniques from CBT (thought pattern recognition), NVC (feelings and needs awareness), and Byron Katie's Work (inquiry and turnarounds) as appropriate for each user's situation.`;
      }
    }

    function buildConversationContext() {
      return conversationHistory.slice(-6); // Keep last 6 exchanges for context
    }

    function addMessage(sender, text) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${sender}`;
      
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.innerHTML = text;
      
      messageDiv.appendChild(bubble);
      chatBox.appendChild(messageDiv);
      chatBox.scrollTop = chatBox.scrollHeight;

      // Update conversation history
      conversationHistory.push({ role: sender, content: text });
    }

    function setLoadingState(isLoading) {
      sendBtn.disabled = isLoading;
      sendText.style.display = isLoading ? 'none' : 'inline';
      loadingSpinner.style.display = isLoading ? 'inline-block' : 'none';
    }

    function updateProgress() {
      const progress = (currentStep / totalSteps) * 100;
      progressFill.style.width = `${Math.min(progress, 100)}%`;
    }

    function updateInsights(userMessage, aiResponse) {
      // Extract and display key insights
      const insightElements = [];
      
      if (userInsights.patterns.length > 0) {
        const latestPattern = userInsights.patterns[userInsights.patterns.length - 1];
        insightElements.push(createInsightElement('Thought Pattern', latestPattern));
      }
      
      if (userInsights.feelings.length > 0) {
        const latestFeeling = userInsights.feelings[userInsights.feelings.length - 1];
        insightElements.push(createInsightElement('Emotional State', latestFeeling));
      }

      // Update insights container
      if (insightElements.length > 0) {
        insightsContainer.innerHTML = '';
        insightElements.forEach(el => insightsContainer.appendChild(el));
      }
    }

    function createInsightElement(label, content) {
      const div = document.createElement('div');
      div.className = 'insight-item';
      div.innerHTML = `
        <div class="insight-label">${label}</div>
        <div class="insight-content">${content}</div>
      `;
      return div;
    }

    function selectFeeling(feeling, isMet) {
      userInsights.feelings.push(`${feeling} (${isMet ? 'need met' : 'need unmet'})`);
      addMessage('user', `I'm feeling ${feeling.toLowerCase()}`);
      closeModal('feelingsModal');
      
      // Auto-suggest exploring needs
      setTimeout(() => {
        addMessage('ai', `Thank you for sharing that you're feeling ${feeling.toLowerCase()}. ${isMet ? 'It sounds like some important needs are being met.' : 'This suggests there might be some unmet needs underneath this feeling.'} Would you like to explore what needs might be connected to this feeling?`);
      }, 500);
    }

    function selectNeed(need) {
      userInsights.needs.push(need);
      addMessage('user', `I have a need for ${need.toLowerCase()}`);
      closeModal('needsModal');
      
      // Auto-suggest strategies
      setTimeout(() => {
        addMessage('ai', `I hear that you have a need for ${need.toLowerCase()}. This is a beautiful and valid human need. What might be some ways you could honor and meet this need? Let's explore some strategies together.`);
      }, 500);
    }

    function openModal(modalId) {
      document.getElementById(modalId).style.display = 'flex';
    }

    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
    }

    function exportJourney() {
      const journeyData = {
        date: new Date().toLocaleDateString(),
        method: currentMethod,
        conversation: conversationHistory,
        insights: userInsights,
        progress: Math.round((currentStep / totalSteps) * 100)
      };

      const exportText = `
INNER FREEDOM JOURNEY EXPORT
Date: ${journeyData.date}
Methodology Focus: ${currentMethod.toUpperCase()}
Progress: ${journeyData.progress}%

=== CONVERSATION SUMMARY ===
${conversationHistory.filter(msg => msg.role === 'user').map((msg, i) => `${i + 1}. ${msg.content}`).join('\n')}

=== KEY INSIGHTS ===
Thought Patterns: ${userInsights.patterns.join(', ') || 'Not yet identified'}
Feelings Explored: ${userInsights.feelings.join(', ') || 'Not yet explored'}
Needs Identified: ${userInsights.needs.join(', ') || 'Not yet identified'}

=== FULL CONVERSATION ===
${conversationHistory.map(msg => `${msg.role.toUpperCase()}: ${msg.content}`).join('\n\n')}

=== REFLECTION SPACE ===
What insights emerged for you during this journey?


What would you like to explore further?


What action steps feel most supportive right now?


---
Generated by Jongu Inner Freedom Journey
For continued exploration, visit: https://jongu.org
      `;

      // Create and download file
      const blob = new Blob([exportText], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `inner-freedom-journey-${new Date().toISOString().split('T')[0]}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      addMessage('ai', 'Your journey has been exported! You can save this file and continue reflecting on your insights. Remember, transformation is an ongoing process - be gentle with yourself as you integrate these discoveries.');
    }

    // Auto-resize textarea
    userInput.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        document.querySelectorAll('.modal').forEach(modal => {
          if (modal.style.display === 'flex') {
            closeModal(modal.id);
          }
        });
      }
    });

    // Initialize the application when the page loads
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>